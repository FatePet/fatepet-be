name: Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ” Connect to EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ë””ë ‰í† ë¦¬ ì—†ìœ¼ë©´ ìƒì„±
            mkdir -p /home/ubuntu/fatepet
            cd /home/ubuntu/fatepet

            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ì‚­ì œ
            rm -rf *

            # GitHubì—ì„œ ìµœì‹  ì½”ë“œ clone (Personal Access Token ì‚¬ìš© í•„ìš” ì—†ìŒ, GitHub Actionsì—ì„œ ì§ì ‘ ë³µì‚¬ë¨)
            # ëŒ€ì‹  í˜„ì¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ ì½”ë“œ ë™ê¸°í™”
            echo "ğŸš€ Pulling latest code via rsync"
            rsync -avz --delete ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/fatepet

            # Docker Compose ì‹¤í–‰
            echo "ğŸ³ Running Docker Compose"
            cd /home/ubuntu/fatepet
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --build
